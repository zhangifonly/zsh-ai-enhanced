# Claude Code Wrapper 工作流程说明

## ✅ 问题已解决

之前报告的"挂起"问题已经解决。实际上 wrapper 一直工作正常，看起来"挂起"的现象是 **Claude Code 的正常行为**：启动后等待用户输入任务。

## 🎯 正常工作流程

### 1. 启动阶段

```bash
[iZsh] ~% claude
```

**输出**：
```
🤖 AI 自动确认模式已启用
提示：所有确认将在 3 秒后自动由 AI 选择
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

                                  🚀 启动中  ← 右上角状态指示器
```

**持续时间**：瞬间（<1秒）

---

### 2. 初始化阶段

**状态指示器变化**：
```
🚀 启动中 → 🔄 初始化
```

**持续时间**：0.5秒

**内部操作**：
- 创建伪终端（PTY）
- 设置终端窗口大小
- 配置非阻塞 I/O
- 启动 Claude Code 子进程

---

### 3. 监控阶段

**状态指示器变化**：
```
🔄 初始化 → 🟢 监控中
```

**输出**：
```
▗ ▗   ▖ ▖  Claude Code v2.0.36
           Sonnet 4.5 · API Usage Billing
  ▘▘ ▝▝    /Users/zhangzhen/Documents/ClaudeCode/zsh/zsh
```

**持续时间**：1-2秒

**内部操作**：
- 接收 Claude Code 的欢迎界面输出
- 清理 ANSI 转义序列进行状态检测
- 识别版本信息

---

### 4. 等待任务阶段（⚠️ 容易误认为挂起）

**状态指示器变化**：
```
🟢 监控中 → 🔵 等待任务
```

**输出**：
```
────────────────────────────────────────────────────────────────────────────────
> Try "edit exec.c to..."
────────────────────────────────────────────────────────────────────────────────
  ? for shortcuts                                  Thinking on (tab to toggle)

                                  🔵 等待任务  ← 右上角状态指示器
```

**重要说明**：
- ✅ **这是正常状态，不是挂起！**
- Claude Code 正在等待您输入任务
- 光标位于 `>` 提示符后，可以开始输入
- 此时可以输入任何任务，例如：
  ```
  > 请帮我创建一个 README 文件
  > 分析 exec.c 中的错误
  > 运行测试并修复失败的用例
  ```

**检测机制**：
- 检测到 "Claude Code v2.0.36" → 识别为 Claude Code
- 检测到 "> Try" 或 "for shortcuts" → 识别为等待输入

---

### 5. 工作阶段

**用户输入任务后**：

```
> 请帮我创建一个 README 文件
```

**状态指示器变化流程**：
```
🔵 等待任务 → 🤔 思考中 → 📖 读取文件 → ✏️ 编写代码 → ⚙️ 执行命令 → ✨ 任务完成
```

**Claude Code 输出示例**：
```
I'll create a README file for you.

Creating README.md...
```

**状态变化**：`🔵 等待任务` → `🤔 思考中` → `✏️ 编写代码`

---

### 6. 确认提示阶段（AI 自动接管）

**遇到确认提示时**：

```
Do you want to create README.md? [Y/n]
⏰ 检测到确认提示，倒计时 3 秒...
```

**状态指示器变化流程**：
```
🔵 等待任务 → 🟡 等待确认 → 🧠 AI分析中 → ⏱️ 倒计时 3s → ⏱️ 倒计时 2s → ⏱️ 倒计时 1s → 🎯 AI执行中 → ✅ AI已选择 → 🟢 监控中
```

**输出**：
```
✅ AI 自动选择: Y
```

**用户可随时干预**：
- 倒计时期间随时按键会立即停止 AI 接管
- 您的输入优先级最高

---

### 7. 任务完成阶段

**状态指示器变化**：
```
🟢 监控中 → ✨ 任务完成 → 🔵 等待任务
```

**输出**：
```
Done! Created README.md

────────────────────────────────────────────────────────────────────────────────
> Try "write a test for <filepath>"
────────────────────────────────────────────────────────────────────────────────
  ? for shortcuts

                                  🔵 等待任务  ← 又回到等待输入状态
```

---

## 🔧 调试模式

如果遇到问题，启用调试模式：

```bash
IZSH_DEBUG_MODE=1 IZSH_SHOW_INDICATOR=0 claude
```

**调试输出示例**：
```
[DEBUG] stdin is TTY: False
[DEBUG] Command: /opt/homebrew/bin/claude
[DEBUG] Creating PTY...
[DEBUG] Parent process, child PID: 12345
[DEBUG] Master FD: 3
[DEBUG] Set PTY window size: 80x24
[DEBUG] Set master_fd to non-blocking mode
[DEBUG] Entering main loop...
[DEBUG] Loop 0: Waiting for I/O (watching 1 fds)...
[DEBUG] Ready fds: 1
[DEBUG] Received 1024 bytes from child
[DEBUG] Clean line: '▗ ▗   ▖ ▖  Claude Code v2.0.36'
[DEBUG] Detected waiting for input
```

**调试模式说明**：
- `IZSH_DEBUG_MODE=1`：启用详细日志
- `IZSH_SHOW_INDICATOR=0`：禁用状态指示器（避免干扰输出）

---

## 🎨 状态指示器快速参考

| 图标 | 状态 | 含义 | 持续时间 |
|------|------|------|----------|
| 🚀 | 启动中 | 程序刚启动 | <1秒 |
| 🔄 | 初始化 | 加载配置 | 0.5秒 |
| 🟢 | 监控中 | 正常运行，处理中 | 变化中 |
| 🔵 | 等待任务 | **等待您输入新任务** | 一直等待 |
| 🤔 | 思考中 | AI 正在分析 | 1-5秒 |
| 📖 | 读取文件 | 正在读取代码 | 1-3秒 |
| ✏️ | 编写代码 | 正在创建/修改代码 | 2-10秒 |
| ⚙️ | 执行命令 | 运行 bash/git 等 | 1-30秒 |
| 🔍 | 搜索分析 | 搜索查找内容 | 1-5秒 |
| 🟡 | 等待确认 | 检测到确认提示 | 瞬间 |
| 🧠 | AI分析中 | AI 正在分析选项 | 0.5秒 |
| ⏱️ | 倒计时 Ns | N秒后AI自动响应 | 3秒 |
| 🎯 | AI执行中 | AI 正在发送选择 | 瞬间 |
| ✅ | AI已选择 | AI 刚完成选择 | 1秒 |
| ✨ | 任务完成 | 当前任务已完成 | 瞬间 |

---

## ❓ 常见疑问

### Q1: 为什么启动后一直显示"🔵 等待任务"？

**A**: 这是正常状态！Claude Code 已经准备好，等待您输入任务。直接在 `>` 提示符后输入您的需求即可。

---

### Q2: 如何知道 Claude Code 真的在工作，而不是卡住了？

**A**: 观察右上角的状态指示器：
- 如果状态在变化（🤔→📖→✏️→⚙️），说明正在工作
- 如果长时间停留在"🔵 等待任务"，说明在等您输入
- 如果长时间停留在其他状态（如🤔超过1分钟），可能有问题

---

### Q3: AI 自动确认会不会做出错误选择？

**A**: AI 遵循以下原则选择：
1. 选择最完整、最全面的方案
2. 优先选择"推荐"或"默认"选项
3. 选择能让程序继续的选项（不选"跳过"、"取消"）
4. 避免危险操作（如删除、覆盖）

如果不放心，倒计时期间随时可以手动干预。

---

### Q4: 如何禁用 AI 自动确认？

**A**: 直接运行原始 Claude Code：

```bash
/opt/homebrew/bin/claude
```

或者修改 `~/.izshrc`，注释掉 `alias claude=...` 这一行。

---

### Q5: 状态指示器可以关闭吗？

**A**: 可以，设置环境变量：

```bash
IZSH_SHOW_INDICATOR=0 claude
```

或永久关闭：在 `~/.izshrc` 中添加 `export IZSH_SHOW_INDICATOR=0`

---

## 📚 相关文档

- [完整版状态指示器说明.md](./完整版状态指示器说明.md) - 所有 25 个状态的详细说明
- [状态指示器快速参考.md](./状态指示器快速参考.md) - 快速查询卡
- [PTY版本说明.md](./PTY版本说明.md) - 技术实现细节
- [Claude_AI自动确认使用指南.md](./Claude_AI自动确认使用指南.md) - AI 自动确认详细说明
- [test_wrapper_debug.sh](./test_wrapper_debug.sh) - 调试测试脚本

---

**版本**: 2.4.0
**状态**: ✅ 生产就绪
**更新时间**: 2025-11-10

**问题已解决**：之前认为的"挂起"问题实际上是正常的"等待任务"状态。
