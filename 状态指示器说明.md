# AI 监控状态指示器 - 使用说明

## ✨ 功能概述

在终端右上角显示一个实时状态指示器，让您随时了解 AI 监控的当前状态。

## 🎯 状态类型

### 1. 🟢 AI监控中（正常运行）
**显示时机**：Claude Code 正在正常执行任务
- AI 正在后台监控输出
- 检测确认提示和菜单
- 等待可能的交互

**示例场景**：
```
🟢 AI监控中  ← 右上角显示

> I'll create a README for you...
> Reading files...
> Analyzing code...
```

### 2. 🔵 等待输入（需要用户输入新任务）
**显示时机**：Claude Code 完成当前任务，等待用户输入下一个任务

**触发条件**：
- 检测到 "How can I help you?"
- 检测到 "What would you like me to do?"
- 检测到 "What's next?"
- 检测到单独的 `>` 提示符

**示例场景**：
```
🔵 等待输入  ← 右上角显示

How can I help you?
> _  ← 等待您输入新任务
```

### 3. 🟡 等待确认（检测到确认提示）
**显示时机**：检测到需要确认的提示，准备倒计时

**触发条件**：
- 文本确认：`[Y/n]`, `[yes/no]`
- 数字菜单：`❯ 1. Yes`
- 多选项：`1) Option A  2) Option B`

**示例场景**：
```
🟡 等待确认  ← 右上角显示

Do you want to create README.md? [Y/n]
⏰ 检测到确认提示，倒计时 3 秒...
```

### 4. ⏱️ 倒计时 Ns（AI 自动确认倒计时）
**显示时机**：正在倒计时，N 秒后 AI 自动选择

**动态更新**：
```
⏱️  倒计时 3s  ← 右上角显示（3秒）
⏱️  倒计时 2s  ← 1秒后更新（2秒）
⏱️  倒计时 1s  ← 再1秒后更新（1秒）
✅ AI 自动选择: Y  ← 倒计时结束
```

**用户可随时干预**：
- 倒计时期间，您随时可以按键
- 一旦检测到按键，AI 停止介入
- 您的输入优先级最高

## 🎨 显示位置

状态指示器固定在**终端右上角**，不干扰正常输出：

```
┌─────────────────────────────────────────────────────── 🟢 AI监控中 ─┐
│                                                                      │
│ Welcome to Claude Code                                              │
│ Working directory: /Users/zhangzhen/...                             │
│                                                                      │
│ How can I help you?                                                 │
│ > _                                                                  │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

## 🔄 状态流转

典型的状态流转流程：

```
启动
 ↓
🟢 AI监控中 (Claude Code 启动)
 ↓
🟢 AI监控中 (执行任务中)
 ↓
🔵 等待输入 (任务完成，等待新任务)
 ↓
[用户输入新任务]
 ↓
🟢 AI监控中 (执行新任务)
 ↓
🟡 等待确认 (遇到确认提示)
 ↓
⏱️  倒计时 3s → 2s → 1s
 ↓
🟢 AI监控中 (AI 已自动选择，继续执行)
```

## 🛠️ 技术实现

### ANSI 转义序列

使用以下 ANSI 转义序列实现：
```python
\033[s        # 保存当前光标位置
\033[1;{col}H # 移动光标到第1行第col列（右上角）
\033[K        # 清除从光标到行尾
{indicator}   # 显示状态文字
\033[u        # 恢复光标位置
```

### 智能检测

**等待输入检测**：
```python
patterns = [
    r'How can I help you\?',
    r'What would you like me to do\?',
    r'>\s*$',  # 单独的 > 提示符
]
```

**确认提示检测**：
```python
patterns = [
    r'\[Y/n\]|\[y/N\]',
    r'❯\s*\d+\.',
    r'\[1/2/3\]',
]
```

### 终端大小自适应

自动获取终端大小并计算指示器位置：
```python
width, height = get_terminal_size()
indicator_width = calculate_display_width(indicator)
col = width - indicator_width - 2  # 右对齐，留边距
```

## 💡 使用建议

### 场景 1：批量任务执行

当您需要离开电脑让 Claude Code 自动执行多个任务时：

```bash
[iZsh] ~% claude

# 输入任务清单
> 请依次完成以下任务：
> 1. 创建项目结构
> 2. 编写测试用例
> 3. 实现核心功能
> 4. 运行测试

# 然后离开
# AI 会自动处理所有确认提示
# 状态指示器让您回来时能快速了解进度
```

### 场景 2：监控长时间任务

对于需要长时间运行的任务：

```bash
# 观察状态变化了解进度
🟢 AI监控中  → 正在执行
🟡 等待确认  → 遇到确认，准备自动处理
⏱️  倒计时   → AI 即将自动选择
🟢 AI监控中  → 继续执行
🔵 等待输入  → 任务完成！
```

### 场景 3：调试和问题排查

当任务卡住时，查看状态指示器：

- **显示 🟢 AI监控中**：Claude Code 正在工作，耐心等待
- **显示 🔵 等待输入**：任务已完成，需要新指令
- **显示 🟡 等待确认**：AI 检测到提示，即将自动处理
- **长时间 ⏱️ 倒计时**：可能检测逻辑有问题（手动干预）

## 🎊 优势

1. **实时可见**：不用猜测 AI 是否在监控
2. **状态清晰**：一目了然当前在做什么
3. **不干扰输出**：固定在右上角，不影响正常内容
4. **动态更新**：实时反映最新状态
5. **倒计时提醒**：明确告知 AI 何时介入
6. **区分等待类型**：清楚知道是等确认还是等新任务

## 📝 配置

状态指示器已默认启用，无需额外配置。

如需自定义，可修改 `claude_code_wrapper_pty.py`：

```python
# 修改状态图标
STATE_ICONS = {
    'running': '🟢 AI监控中',
    'input': '🔵 等待输入',
    'confirm': '🟡 等待确认',
    'countdown': '⏱️  倒计时',
}

# 修改倒计时时长
timeout = int(os.environ.get('IZSH_AI_CONFIRM_TIMEOUT', 3))
```

---

**版本**: 2.3.0
**状态**: ✅ 已启用
**更新时间**: 2025-11-10
