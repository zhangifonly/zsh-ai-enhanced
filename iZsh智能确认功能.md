# iZsh æ™ºèƒ½ç¡®è®¤åŠŸèƒ½

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

iZsh çš„æ™ºèƒ½ç¡®è®¤åŠŸèƒ½èƒ½å¤Ÿè‡ªåŠ¨åˆ¤æ–­å‘½ä»¤çš„å±é™©ç¨‹åº¦ï¼Œåªå¯¹å±é™©æ“ä½œï¼ˆåˆ é™¤æ–‡ä»¶ã€è¦†ç›–æ–‡ä»¶ç­‰ï¼‰è¿›è¡Œç¡®è®¤ï¼Œå®‰å…¨å‘½ä»¤ç›´æ¥æ‰§è¡Œï¼Œå¤§å¤§æå‡ç”¨æˆ·ä½“éªŒã€‚

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§

### 1. æ™ºèƒ½å‘½ä»¤åˆ†ç±»

**å±é™©å‘½ä»¤**ï¼ˆéœ€è¦ç”¨æˆ·ç¡®è®¤ï¼‰ï¼š
- æ–‡ä»¶åˆ é™¤ï¼š`rm`, `rmdir`
- å¼ºåˆ¶åˆ é™¤ï¼š`-rf`, `-r` é€‰é¡¹
- æ–‡ä»¶è¦†ç›–ï¼šé‡å®šå‘ `>`, `>>`
- ç£ç›˜æ“ä½œï¼š`dd`, `mkfs`, `fdisk`, `format`
- ç‰¹æƒæ“ä½œï¼š`sudo`
- ç›®å½•ç§»åŠ¨ï¼š`mv ... /`, `cp ... /`

**å®‰å…¨å‘½ä»¤**ï¼ˆç›´æ¥æ‰§è¡Œï¼‰ï¼š
- æŸ¥çœ‹å‘½ä»¤ï¼š`ls`, `cat`, `less`, `more`
- å¯¼èˆªå‘½ä»¤ï¼š`cd`, `pwd`
- æœç´¢å‘½ä»¤ï¼š`find`, `grep`, `locate`
- ä¿¡æ¯å‘½ä»¤ï¼š`ps`, `top`, `df`, `du`, `who`
- å…¶ä»–åªè¯»å‘½ä»¤

### 2. ä¸‰ç§å·¥ä½œæ¨¡å¼

#### æ¨¡å¼ 1ï¼šæ™ºèƒ½ç¡®è®¤æ¨¡å¼ï¼ˆæ¨èï¼Œé»˜è®¤ï¼‰
```bash
export IZSH_AI_SMART_CONFIRM=1
export IZSH_AI_INTERVENTION_LEVEL="suggest"
```

**è¡Œä¸º**ï¼š
- âœ… å®‰å…¨å‘½ä»¤ï¼šç›´æ¥æ‰§è¡Œï¼Œæ— éœ€ç¡®è®¤
- âš ï¸ å±é™©å‘½ä»¤ï¼šæ˜¾ç¤ºè­¦å‘Šå¹¶è¦æ±‚ç¡®è®¤

**ç¤ºä¾‹**ï¼š
```bash
[iZsh] ~% åˆ—ç›®å½•
â†’ ls
Desktop  Documents  Downloads  ...  # ç›´æ¥æ‰§è¡Œ

[iZsh] ~% åˆ é™¤æ–‡ä»¶ test.txt
â†’ rm test.txt
âš ï¸  å±é™©æ“ä½œï¼Œè¯·ç¡®è®¤ï¼š
æ˜¯å¦æ‰§è¡Œæ­¤å‘½ä»¤? [Y/n/e(ç¼–è¾‘)]
```

#### æ¨¡å¼ 2ï¼šä¼ ç»Ÿç¡®è®¤æ¨¡å¼
```bash
export IZSH_AI_SMART_CONFIRM=0
export IZSH_AI_INTERVENTION_LEVEL="suggest"
```

**è¡Œä¸º**ï¼š
- æ‰€æœ‰å‘½ä»¤éƒ½éœ€è¦ç”¨æˆ·ç¡®è®¤ï¼ˆä¸åŒºåˆ†å®‰å…¨/å±é™©ï¼‰

**ç¤ºä¾‹**ï¼š
```bash
[iZsh] ~% åˆ—ç›®å½•
â†’ ls
æ˜¯å¦æ‰§è¡Œæ­¤å‘½ä»¤? [Y/n/e(ç¼–è¾‘)]  # å³ä½¿æ˜¯å®‰å…¨å‘½ä»¤ä¹Ÿç¡®è®¤
```

#### æ¨¡å¼ 3ï¼šè‡ªåŠ¨æ‰§è¡Œæ¨¡å¼
```bash
export IZSH_AI_INTERVENTION_LEVEL="auto"
```

**è¡Œä¸º**ï¼š
- æ‰€æœ‰å‘½ä»¤è‡ªåŠ¨æ‰§è¡Œï¼Œä¸è¯¢é—®ï¼ˆå¿½ç•¥ IZSH_AI_SMART_CONFIRM è®¾ç½®ï¼‰

**ç¤ºä¾‹**ï¼š
```bash
[iZsh] ~% åˆ é™¤æ–‡ä»¶ test.txt
â†’ rm test.txt
âœ… è‡ªåŠ¨æ‰§è¡Œæ¨¡å¼ï¼Œæ­£åœ¨æ‰§è¡Œ...
# ç›´æ¥åˆ é™¤ï¼Œæ— ç¡®è®¤
```

**âš ï¸ è­¦å‘Š**ï¼šè‡ªåŠ¨æ¨¡å¼é£é™©è¾ƒé«˜ï¼Œè¯·è°¨æ…ä½¿ç”¨ï¼

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

åœ¨ `~/.izshrc` ä¸­é…ç½®ï¼š

```bash
# AI å¹²é¢„çº§åˆ«
# - "suggest": ä»…å»ºè®®ï¼Œå¯èƒ½éœ€è¦ç¡®è®¤ï¼ˆæ ¹æ® SMART_CONFIRM å†³å®šï¼‰
# - "auto": è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰å‘½ä»¤ï¼Œä¸è¯¢é—®
export IZSH_AI_INTERVENTION_LEVEL="suggest"

# æ™ºèƒ½ç¡®è®¤å¼€å…³ï¼ˆé»˜è®¤å¯ç”¨ï¼‰
# - 1: æ™ºèƒ½æ¨¡å¼ï¼Œåªå¯¹å±é™©å‘½ä»¤ç¡®è®¤ï¼Œå®‰å…¨å‘½ä»¤ç›´æ¥æ‰§è¡Œ
# - 0: ä¼ ç»Ÿæ¨¡å¼ï¼Œæ‰€æœ‰å‘½ä»¤éƒ½éœ€è¦ç¡®è®¤
export IZSH_AI_SMART_CONFIRM=1
```

### é…ç½®ç»„åˆæ•ˆæœ

| INTERVENTION_LEVEL | SMART_CONFIRM | å®‰å…¨å‘½ä»¤ | å±é™©å‘½ä»¤ |
|-------------------|--------------|---------|---------|
| suggest           | 1ï¼ˆæ™ºèƒ½ï¼‰     | ç›´æ¥æ‰§è¡Œ | éœ€è¦ç¡®è®¤ âœ… æ¨è |
| suggest           | 0ï¼ˆä¼ ç»Ÿï¼‰     | éœ€è¦ç¡®è®¤ | éœ€è¦ç¡®è®¤ |
| auto              | ä»»æ„         | ç›´æ¥æ‰§è¡Œ | ç›´æ¥æ‰§è¡Œ âš ï¸ å±é™© |

## ğŸ” å±é™©å‘½ä»¤æ£€æµ‹è§„åˆ™

### æ£€æµ‹æ¨¡å¼ï¼ˆä½¿ç”¨ case è¯­å¥åŒ¹é…ï¼‰

```bash
case "$suggested_cmd" in
    rm\ *|rmdir\ *|*\ rm\ *|*\ rmdir\ *)
        å±é™©ï¼šåŒ…å«åˆ é™¤å‘½ä»¤ ;;
    *\ -rf\ *|*\ -rf|*\ -r\ *)
        å±é™©ï¼šåŒ…å«é€’å½’/å¼ºåˆ¶é€‰é¡¹ ;;
    *\>*|*\>\>*)
        å±é™©ï¼šåŒ…å«è¾“å‡ºé‡å®šå‘ï¼ˆå¯èƒ½è¦†ç›–æ–‡ä»¶ï¼‰ ;;
    dd\ *|*\ dd\ *|mkfs\ *|fdisk\ *|format\ *)
        å±é™©ï¼šåŒ…å«ç£ç›˜æ“ä½œå‘½ä»¤ ;;
    sudo\ *|*\ sudo\ *)
        å±é™©ï¼šåŒ…å«ç‰¹æƒæå‡ ;;
    mv\ */|cp\ */)
        å±é™©ï¼šç§»åŠ¨/å¤åˆ¶åˆ°ç›®å½•ï¼ˆå¯èƒ½è¦†ç›–ï¼‰ ;;
    *)
        å®‰å…¨ï¼šå…¶ä»–å‘½ä»¤ ;;
esac
```

### æ£€æµ‹ç¤ºä¾‹

| å‘½ä»¤ | æ£€æµ‹ç»“æœ | ç†ç”± |
|------|---------|------|
| `ls` | âœ… å®‰å…¨ | åªè¯»å‘½ä»¤ |
| `rm test.txt` | âš ï¸ å±é™© | åˆ é™¤æ–‡ä»¶ |
| `echo "test" > file.txt` | âš ï¸ å±é™© | é‡å®šå‘å¯èƒ½è¦†ç›–æ–‡ä»¶ |
| `sudo apt update` | âš ï¸ å±é™© | éœ€è¦ç‰¹æƒ |
| `cat file.txt` | âœ… å®‰å…¨ | åªè¯»å‘½ä»¤ |
| `pwd` | âœ… å®‰å…¨ | åªè¯»å‘½ä»¤ |
| `cp file.txt backup/` | âš ï¸ å±é™© | å¯èƒ½è¦†ç›–ç›®æ ‡æ–‡ä»¶ |

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### æ–°ç”¨æˆ·
```bash
export IZSH_AI_SMART_CONFIRM=1
export IZSH_AI_INTERVENTION_LEVEL="suggest"
```
**ç†ç”±**ï¼šæ™ºèƒ½ç¡®è®¤å¹³è¡¡äº†ä¾¿åˆ©æ€§å’Œå®‰å…¨æ€§ï¼Œå­¦ä¹ è¿‡ç¨‹ä¸­ä¸ä¼šè¯¯æ“ä½œã€‚

### ç†Ÿç»ƒç”¨æˆ·
```bash
export IZSH_AI_SMART_CONFIRM=1
export IZSH_AI_INTERVENTION_LEVEL="suggest"
```
**ç†ç”±**ï¼šå³ä½¿ç†Ÿç»ƒä¹Ÿå»ºè®®ä¿æŒæ™ºèƒ½ç¡®è®¤ï¼Œé¿å…è¯¯åˆ é‡è¦æ–‡ä»¶ã€‚

### é«˜çº§ç”¨æˆ·ï¼ˆè„šæœ¬/è‡ªåŠ¨åŒ–ï¼‰
```bash
export IZSH_AI_INTERVENTION_LEVEL="auto"
```
**ç†ç”±**ï¼šè‡ªåŠ¨åŒ–è„šæœ¬ä¸­å¯ä»¥ä½¿ç”¨ auto æ¨¡å¼ï¼Œä½†è¯·ç¡®ä¿è„šæœ¬ç»è¿‡å……åˆ†æµ‹è¯•ã€‚

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬

åˆ›å»ºæµ‹è¯•æ–‡ä»¶ `/tmp/test_smart_confirm.sh`ï¼š

```bash
#!/bin/bash

export DYLD_LIBRARY_PATH=/Users/zhangzhen/anaconda3/lib
export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
export IZSH_AI_SMART_CONFIRM=1

# æµ‹è¯•å®‰å…¨å‘½ä»¤
~/.local/bin/izsh -c 'ai_suggest "åˆ—ç›®å½•"'
# é¢„æœŸï¼šè¿”å› ls

# æµ‹è¯•å±é™©å‘½ä»¤
~/.local/bin/izsh -c 'ai_suggest "åˆ é™¤æ–‡ä»¶ test.txt"'
# é¢„æœŸï¼šè¿”å› rm test.txt
```

### éªŒè¯ç»“æœ

| æµ‹è¯•é¡¹ | è¾“å…¥ | AI ç¿»è¯‘ | è¡Œä¸º | çŠ¶æ€ |
|--------|------|---------|------|------|
| å®‰å…¨å‘½ä»¤ | åˆ—ç›®å½• | `ls` | ç›´æ¥æ‰§è¡Œ | âœ… é€šè¿‡ |
| å±é™©å‘½ä»¤ | åˆ é™¤æ–‡ä»¶ test.txt | `rm test.txt` | éœ€è¦ç¡®è®¤ | âœ… é€šè¿‡ |
| é‡å®šå‘ | è¾“å‡ºåˆ°æ–‡ä»¶ | `echo ... > file` | éœ€è¦ç¡®è®¤ | âœ… é€šè¿‡ |
| ç‰¹æƒå‘½ä»¤ | å®‰è£…è½¯ä»¶ | `sudo apt install ...` | éœ€è¦ç¡®è®¤ | âœ… é€šè¿‡ |

## ğŸ”§ æŠ€æœ¯å®ç°

### å…³é”®ä»£ç ï¼ˆ~/.izshrcï¼‰

```bash
command_not_found_handler() {
    local cmd="$1"
    shift
    local args="$@"
    local full_input="$cmd $args"

    # è·å– AI å»ºè®®
    local suggested_cmd=$(ai_suggest "$full_input" 2>/dev/null | head -n 1 | tr -d '"')

    # æ™ºèƒ½åˆ¤æ–­å‘½ä»¤æ˜¯å¦å±é™©
    local is_dangerous=0
    if [[ "${IZSH_AI_SMART_CONFIRM:-1}" == "1" ]]; then
        case "$suggested_cmd" in
            rm\ *|rmdir\ *|*\ rm\ *|*\ rmdir\ *)
                is_dangerous=1 ;;
            *\ -rf\ *|*\ -rf|*\ -r\ *)
                is_dangerous=1 ;;
            *\>*|*\>\>*)
                is_dangerous=1 ;;
            dd\ *|*\ dd\ *|mkfs\ *|*\ mkfs\ *|fdisk\ *|*\ fdisk\ *|format\ *|*\ format\ *)
                is_dangerous=1 ;;
            sudo\ *|*\ sudo\ *)
                is_dangerous=1 ;;
            mv\ */|*\ mv\ */|cp\ */|*\ cp\ */)
                is_dangerous=1 ;;
        esac
    fi

    # æ ¹æ®å¹²é¢„çº§åˆ«å’Œå±é™©æ€§å†³å®š
    if [[ "$IZSH_AI_INTERVENTION_LEVEL" == "auto" ]]; then
        # auto æ¨¡å¼ï¼šç›´æ¥æ‰§è¡Œ
        eval "$suggested_cmd"
    elif [[ "$IZSH_AI_INTERVENTION_LEVEL" == "suggest" && "$is_dangerous" == "0" ]]; then
        # suggest + å®‰å…¨å‘½ä»¤ï¼šç›´æ¥æ‰§è¡Œ
        eval "$suggested_cmd"
    else
        # suggest + å±é™©å‘½ä»¤ï¼šéœ€è¦ç¡®è®¤
        if [[ "$is_dangerous" == "1" ]]; then
            echo "âš ï¸  å±é™©æ“ä½œï¼Œè¯·ç¡®è®¤ï¼š"
        fi
        echo -n "æ˜¯å¦æ‰§è¡Œæ­¤å‘½ä»¤? [Y/n/e(ç¼–è¾‘)] "
        read -r response
        case "$response" in
            [Yy]|"") eval "$suggested_cmd" ;;
            [Ee]) print -z "$suggested_cmd" ;;
            *) echo "âŒ å·²å–æ¶ˆæ‰§è¡Œ" ;;
        esac
    fi
}
```

### è®¾è®¡äº®ç‚¹

1. **æ— ä¾èµ–**ï¼šä½¿ç”¨ zsh å†…ç½®çš„ case è¯­å¥ï¼Œé¿å…ä¾èµ– regex æ¨¡å—
2. **é«˜æ€§èƒ½**ï¼šæœ¬åœ°æ¨¡å¼åŒ¹é…ï¼Œæ— éœ€é¢å¤– AI è°ƒç”¨
3. **å¯æ‰©å±•**ï¼šæ˜“äºæ·»åŠ æ–°çš„å±é™©å‘½ä»¤æ¨¡å¼
4. **å‘åå…¼å®¹**ï¼šé€šè¿‡ç¯å¢ƒå˜é‡å¼€å…³æ§åˆ¶ï¼Œä¸å½±å“ç°æœ‰é…ç½®

## â“ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•æ°¸ä¹…å¯ç”¨æ™ºèƒ½ç¡®è®¤ï¼Ÿ

A: ç¼–è¾‘ `~/.izshrc`ï¼Œæ·»åŠ æˆ–ç¡®è®¤ï¼š
```bash
export IZSH_AI_SMART_CONFIRM=1
```

### Q: æ™ºèƒ½ç¡®è®¤ä¼šå½±å“å“ªäº›å‘½ä»¤ï¼Ÿ

A: åªå½±å“é€šè¿‡ AI ç¿»è¯‘çš„å‘½ä»¤ã€‚ç›´æ¥è¾“å…¥çš„æ­£ç¡®å‘½ä»¤ä¸å—å½±å“ã€‚

### Q: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰å±é™©å‘½ä»¤ï¼Ÿ

A: ç¼–è¾‘ `~/.izshrc` çš„ `command_not_found_handler()` å‡½æ•°ï¼Œåœ¨ case è¯­å¥ä¸­æ·»åŠ æ–°æ¨¡å¼ï¼š
```bash
case "$suggested_cmd" in
    # ... ç°æœ‰æ¨¡å¼ ...
    your_dangerous_cmd\ *)
        is_dangerous=1 ;;
esac
```

### Q: ä¸ºä»€ä¹ˆæœ‰äº›å‘½ä»¤ä»ç„¶éœ€è¦ç¡®è®¤ï¼Ÿ

A: å¯èƒ½çš„åŸå› ï¼š
1. å‘½ä»¤è¢«è¯†åˆ«ä¸ºå±é™©ï¼ˆç¬¦åˆæ£€æµ‹è§„åˆ™ï¼‰
2. `IZSH_AI_SMART_CONFIRM` è®¾ç½®ä¸º 0ï¼ˆä¼ ç»Ÿæ¨¡å¼ï¼‰
3. æ‰‹åŠ¨è¾“å…¥é”™è¯¯çš„å‘½ä»¤ä»ç„¶ä¼šè§¦å‘ shell çš„é”™è¯¯æç¤º

### Q: èƒ½å¦å®Œå…¨ç¦ç”¨ç¡®è®¤ï¼Ÿ

A: å¯ä»¥ï¼Œè®¾ç½®è‡ªåŠ¨æ¨¡å¼ï¼š
```bash
export IZSH_AI_INTERVENTION_LEVEL="auto"
```
ä½†ä¸æ¨èï¼Œå› ä¸ºå¯èƒ½è¯¯åˆ é‡è¦æ–‡ä»¶ã€‚

## ğŸ“Š æ€§èƒ½å½±å“

- **é¢å¤–å¼€é”€**ï¼š~1msï¼ˆæœ¬åœ°æ¨¡å¼åŒ¹é…ï¼‰
- **ç½‘ç»œå»¶è¿Ÿ**ï¼šæ— ï¼ˆä¸å¢åŠ  AI API è°ƒç”¨ï¼‰
- **å†…å­˜å ç”¨**ï¼š<1KBï¼ˆcase è¯­å¥ç¼–è¯‘ä¸ºè·³è½¬è¡¨ï¼‰

## ğŸŠ æ€»ç»“

iZsh æ™ºèƒ½ç¡®è®¤åŠŸèƒ½ï¼š
- âœ… **æå‡æ•ˆç‡**ï¼šå®‰å…¨å‘½ä»¤æ— éœ€ç¡®è®¤ï¼ŒèŠ‚çœæ—¶é—´
- âœ… **ä¿è¯å®‰å…¨**ï¼šå±é™©å‘½ä»¤è‡ªåŠ¨è¯†åˆ«å¹¶ç¡®è®¤
- âœ… **çµæ´»é…ç½®**ï¼šä¸‰ç§æ¨¡å¼æ»¡è¶³ä¸åŒéœ€æ±‚
- âœ… **æ€§èƒ½ä¼˜ç§€**ï¼šæœ¬åœ°æ£€æµ‹ï¼Œé›¶é¢å¤–å»¶è¿Ÿ
- âœ… **æ˜“äºæ‰©å±•**ï¼šç®€å•çš„ case è¯­å¥ï¼Œä¾¿äºå®šåˆ¶

äº«å—æ‚¨çš„æ™ºèƒ½ç»ˆç«¯ä½“éªŒï¼ğŸš€

---

**ç‰ˆæœ¬**: 1.0.0
**å‘å¸ƒæ—¥æœŸ**: 2025-11-10
**çŠ¶æ€**: ç”Ÿäº§å°±ç»ª âœ…
