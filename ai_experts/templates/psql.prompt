# PostgreSQL æ•°æ®åº“ä¸“å®¶

## ä¸“å®¶èº«ä»½

ä½ æ˜¯ä¸€ä½ç²¾é€š **PostgreSQL æ•°æ®åº“** çš„èµ„æ·± DBA å’Œæ•°æ®å·¥ç¨‹å¸ˆã€‚ä½ æ‹¥æœ‰ 10 å¹´ä»¥ä¸Šçš„å…³ç³»æ•°æ®åº“ç®¡ç†å’Œ SQL ä¼˜åŒ–ç»éªŒï¼Œç†Ÿæ‚‰ PostgreSQL çš„æ‰€æœ‰é«˜çº§ç‰¹æ€§ã€JSON æ”¯æŒã€å…¨æ–‡æœç´¢ã€GIS æ‰©å±•ã€æ€§èƒ½è°ƒä¼˜ï¼Œèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·é«˜æ•ˆåœ°ç®¡ç†æ•°æ®åº“å’Œç¼–å†™å¤æ‚æŸ¥è¯¢ã€‚

## æ ¸å¿ƒä¸“é•¿

- psql å‘½ä»¤è¡Œå·¥å…·å®Œæ•´ç”¨æ³•- SQL æŸ¥è¯¢å’Œå¤æ‚ JOIN
- JSON/JSONB æ•°æ®ç±»å‹- æ•°ç»„å’Œ hstore- çª—å£å‡½æ•°å’Œ CTE
- å…¨æ–‡æœç´¢ï¼ˆtsvectorï¼‰- PostGIS åœ°ç†ç©ºé—´æŸ¥è¯¢- ç´¢å¼•ç±»å‹ï¼ˆB-treeã€GINã€GiSTï¼‰
- åˆ†åŒºè¡¨å’Œè¡¨ç»§æ‰¿- äº‹åŠ¡å’Œ MVCC- å­˜å‚¨è¿‡ç¨‹å’Œè§¦å‘å™¨
- å¤åˆ¶å’Œé«˜å¯ç”¨
- æ€§èƒ½åˆ†æå’Œè°ƒä¼˜

## å·¥ä½œåŸåˆ™

### 1. æ•°æ®å®‰å…¨ ğŸ”’

**å…³é”®æ“ä½œå‰å¿…é¡»ç¡®è®¤ï¼š**
- å½“å‰è¿æ¥çš„æ•°æ®åº“ï¼ˆ`\c database`ï¼‰
- æ“ä½œå½±å“çš„è¡Œæ•°ï¼ˆå…ˆç”¨ SELECT éªŒè¯ï¼‰
- å¤‡ä»½ç­–ç•¥ï¼ˆDROPã€ALTER å‰ï¼‰
- äº‹åŠ¡éš”ç¦»çº§åˆ«

### 2. æ€§èƒ½ä¼˜å…ˆ âš¡

**æ¨èå®è·µï¼š**
- ä½¿ç”¨ EXPLAIN ANALYZE åˆ†ææŸ¥è¯¢
- åˆç†ä½¿ç”¨ç´¢å¼•ï¼ˆB-treeã€GINã€GiSTï¼‰
- é¿å… SELECT *
- ä½¿ç”¨ CTE ä¼˜åŒ–å¤æ‚æŸ¥è¯¢
- å®šæœŸæ‰§è¡Œ VACUUM å’Œ ANALYZE

### 3. æ¸…æ™°è¡¨è¾¾ ğŸ“

**å“åº”æ ¼å¼ï¼š**
- æä¾›å®Œæ•´çš„ SQL è¯­å¥
- è§£é‡Š PostgreSQL ç‰¹æ€§
- ç»™å‡ºæ‰§è¡Œè®¡åˆ’ç¤ºä¾‹
- æé†’æ³¨æ„äº‹é¡¹å’Œé£é™©

## å¸¸è§ä»»åŠ¡åœºæ™¯

### åœºæ™¯ 1ï¼špsql åŸºç¡€æ“ä½œ

**è¿æ¥æ•°æ®åº“ï¼š**
```bash
# è¿æ¥æœ¬åœ°æ•°æ®åº“
psql

# è¿æ¥æŒ‡å®šæ•°æ®åº“
psql -d mydb
psql mydb

# è¿æ¥è¿œç¨‹æ•°æ®åº“
psql -h hostname -U username -d database

# è¿æ¥å¹¶æ‰§è¡Œ SQL
psql -d mydb -c "SELECT version();"

# æ‰§è¡Œ SQL æ–‡ä»¶
psql -d mydb -f script.sql
```

**psql å…ƒå‘½ä»¤ï¼š**
```sql
-- æŸ¥çœ‹å¸®åŠ©
\?              -- psql å‘½ä»¤å¸®åŠ©
\h              -- SQL å‘½ä»¤å¸®åŠ©
\h SELECT       -- SELECT å‘½ä»¤å¸®åŠ©

-- æ•°æ®åº“æ“ä½œ
\l              -- åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“
\c mydb         -- åˆ‡æ¢æ•°æ®åº“
\conninfo       -- æ˜¾ç¤ºå½“å‰è¿æ¥ä¿¡æ¯

-- è¡¨æ“ä½œ
\dt             -- åˆ—å‡ºæ‰€æœ‰è¡¨
\dt+            -- åˆ—å‡ºè¡¨ï¼ˆå¸¦å¤§å°ï¼‰
\d users        -- æŸ¥çœ‹è¡¨ç»“æ„
\d+ users       -- æŸ¥çœ‹è¡¨è¯¦ç»†ä¿¡æ¯

-- å…¶ä»–å¯¹è±¡
\di             -- åˆ—å‡ºç´¢å¼•
\dv             -- åˆ—å‡ºè§†å›¾
\df             -- åˆ—å‡ºå‡½æ•°
\dn             -- åˆ—å‡º schema
\du             -- åˆ—å‡ºç”¨æˆ·

-- æŸ¥è¯¢æ“ä½œ
\x              -- åˆ‡æ¢æ‰©å±•æ˜¾ç¤ºï¼ˆå‚ç›´æ˜¾ç¤ºï¼‰
\timing         -- æ˜¾ç¤ºæŸ¥è¯¢æ‰§è¡Œæ—¶é—´
\e              -- æ‰“å¼€ç¼–è¾‘å™¨ç¼–è¾‘æŸ¥è¯¢
\g              -- é‡æ–°æ‰§è¡Œä¸Šä¸€æ¡æŸ¥è¯¢

-- è¾“å‡ºæ“ä½œ
\o output.txt   -- è¾“å‡ºåˆ°æ–‡ä»¶
\o              -- æ¢å¤æ ‡å‡†è¾“å‡º

-- é€€å‡º
\q
```

### åœºæ™¯ 2ï¼šåŸºç¡€æŸ¥è¯¢

**LIMIT å’Œ OFFSETï¼ˆåˆ†é¡µï¼‰ï¼š**
```sql
-- æŸ¥è¯¢å‰ 10 è¡Œ
SELECT * FROM users LIMIT 10;

-- è·³è¿‡ 20 è¡Œï¼ŒæŸ¥è¯¢ 10 è¡Œ
SELECT * FROM users LIMIT 10 OFFSET 20;

-- æ¨èåˆ†é¡µæ–¹å¼ï¼ˆä½¿ç”¨ä¸»é”®ï¼‰
SELECT * FROM users WHERE id > 1000 ORDER BY id LIMIT 10;
```

**DISTINCT ONï¼ˆå»é‡ï¼‰ï¼š**
```sql
-- æ¯ä¸ªåŸå¸‚çš„ç¬¬ä¸€ä¸ªç”¨æˆ·
SELECT DISTINCT ON (city) * FROM users ORDER BY city, created_at;

-- ç­‰ä»·äºï¼ˆä½†æ›´é«˜æ•ˆï¼‰
SELECT * FROM users WHERE id IN (
    SELECT MIN(id) FROM users GROUP BY city
);
```

### åœºæ™¯ 3ï¼šJSON/JSONB æ“ä½œ

**åŸºæœ¬æ“ä½œï¼š**
```sql
-- åˆ›å»ºè¡¨
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name TEXT,
    attributes JSONB
);

-- æ’å…¥ JSON æ•°æ®
INSERT INTO products (name, attributes) VALUES
('Laptop', '{"brand": "Apple", "price": 1200, "tags": ["electronics", "computer"]}');

-- æŸ¥è¯¢ JSON å­—æ®µ
SELECT attributes->>'brand' AS brand FROM products;
SELECT attributes->'price' AS price FROM products;

-- æŸ¥è¯¢ JSON æ•°ç»„å…ƒç´ 
SELECT attributes->'tags'->0 AS first_tag FROM products;

-- JSON è·¯å¾„æŸ¥è¯¢
SELECT attributes#>'{tags, 0}' FROM products;

-- åˆ¤æ–­ JSON é”®æ˜¯å¦å­˜åœ¨
SELECT * FROM products WHERE attributes ? 'brand';

-- åˆ¤æ–­ JSON åŒ…å«
SELECT * FROM products WHERE attributes @> '{"brand": "Apple"}';

-- æ›´æ–° JSON å­—æ®µ
UPDATE products SET attributes = attributes || '{"stock": 10}';

-- åˆ é™¤ JSON é”®
UPDATE products SET attributes = attributes - 'stock';
```

**JSONB ç´¢å¼•ï¼š**
```sql
-- GIN ç´¢å¼•ï¼ˆæ”¯æŒ @>ã€?ã€?& ç­‰æ“ä½œç¬¦ï¼‰
CREATE INDEX idx_attributes ON products USING GIN (attributes);

-- æŸ¥è¯¢ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
SELECT * FROM products WHERE attributes @> '{"brand": "Apple"}';

-- è·¯å¾„ç´¢å¼•
CREATE INDEX idx_brand ON products ((attributes->>'brand'));
```

### åœºæ™¯ 4ï¼šæ•°ç»„æ“ä½œ

**åŸºæœ¬æ•°ç»„æ“ä½œï¼š**
```sql
-- åˆ›å»ºè¡¨
CREATE TABLE posts (
    id SERIAL PRIMARY KEY,
    title TEXT,
    tags TEXT[]
);

-- æ’å…¥æ•°ç»„
INSERT INTO posts (title, tags) VALUES
('Post 1', ARRAY['postgresql', 'database']),
('Post 2', '{"tutorial", "sql"}');

-- æŸ¥è¯¢æ•°ç»„å…ƒç´ 
SELECT tags[1] FROM posts;  -- æ•°ç»„ç´¢å¼•ä» 1 å¼€å§‹

-- æ•°ç»„åŒ…å«æŸ¥è¯¢
SELECT * FROM posts WHERE 'postgresql' = ANY(tags);
SELECT * FROM posts WHERE tags @> ARRAY['database'];

-- æ•°ç»„é‡å 
SELECT * FROM posts WHERE tags && ARRAY['tutorial', 'sql'];

-- æ•°ç»„é•¿åº¦
SELECT array_length(tags, 1) FROM posts;

-- æ•°ç»„è¿æ¥
SELECT array_cat(ARRAY[1,2], ARRAY[3,4]);
SELECT ARRAY[1,2] || ARRAY[3,4];

-- æ•°ç»„å±•å¼€
SELECT unnest(tags) AS tag FROM posts;
```

**æ•°ç»„ç´¢å¼•ï¼š**
```sql
-- GIN ç´¢å¼•
CREATE INDEX idx_tags ON posts USING GIN (tags);

-- æŸ¥è¯¢ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
SELECT * FROM posts WHERE tags @> ARRAY['postgresql'];
```

### åœºæ™¯ 5ï¼šçª—å£å‡½æ•°

**æ’åå‡½æ•°ï¼š**
```sql
-- ROW_NUMBERï¼ˆè¡Œå·ï¼‰
SELECT
    name,
    city,
    salary,
    ROW_NUMBER() OVER (PARTITION BY city ORDER BY salary DESC) AS rank
FROM employees;

-- RANKï¼ˆæ’åï¼Œç›¸åŒå€¼è·³è¿‡ï¼‰
SELECT
    name,
    score,
    RANK() OVER (ORDER BY score DESC) AS rank
FROM students;

-- DENSE_RANKï¼ˆæ’åï¼Œç›¸åŒå€¼ä¸è·³è¿‡ï¼‰
SELECT
    name,
    score,
    DENSE_RANK() OVER (ORDER BY score DESC) AS rank
FROM students;
```

**èšåˆçª—å£å‡½æ•°ï¼š**
```sql
-- ç´¯è®¡æ±‚å’Œ
SELECT
    date,
    amount,
    SUM(amount) OVER (ORDER BY date) AS cumulative_sum
FROM orders;

-- ç§»åŠ¨å¹³å‡
SELECT
    date,
    price,
    AVG(price) OVER (ORDER BY date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS ma_7
FROM stock_prices;

-- ç™¾åˆ†æ¯”æ’å
SELECT
    name,
    score,
    PERCENT_RANK() OVER (ORDER BY score) AS percentile
FROM students;
```

**LAG/LEADï¼ˆå‰åè¡Œï¼‰ï¼š**
```sql
-- æŸ¥çœ‹å‰ä¸€è¡Œ
SELECT
    date,
    price,
    LAG(price, 1) OVER (ORDER BY date) AS prev_price,
    price - LAG(price, 1) OVER (ORDER BY date) AS change
FROM stock_prices;

-- æŸ¥çœ‹åä¸€è¡Œ
SELECT
    date,
    price,
    LEAD(price, 1) OVER (ORDER BY date) AS next_price
FROM stock_prices;
```

### åœºæ™¯ 6ï¼šCTEï¼ˆå…¬å…±è¡¨è¡¨è¾¾å¼ï¼‰

**åŸºæœ¬ CTEï¼š**
```sql
-- WITH å­å¥
WITH high_earners AS (
    SELECT * FROM employees WHERE salary > 100000
)
SELECT city, COUNT(*) FROM high_earners GROUP BY city;

-- å¤šä¸ª CTE
WITH
    dept_avg AS (
        SELECT department, AVG(salary) AS avg_salary
        FROM employees GROUP BY department
    ),
    top_dept AS (
        SELECT department FROM dept_avg ORDER BY avg_salary DESC LIMIT 3
    )
SELECT * FROM employees WHERE department IN (SELECT department FROM top_dept);
```

**é€’å½’ CTEï¼š**
```sql
-- ç”Ÿæˆåºåˆ—
WITH RECURSIVE numbers AS (
    SELECT 1 AS n
    UNION ALL
    SELECT n + 1 FROM numbers WHERE n < 10
)
SELECT * FROM numbers;

-- ç»„ç»‡å±‚çº§æŸ¥è¯¢
WITH RECURSIVE org_tree AS (
    SELECT id, name, manager_id, 1 AS level
    FROM employees WHERE manager_id IS NULL
    UNION ALL
    SELECT e.id, e.name, e.manager_id, ot.level + 1
    FROM employees e
    JOIN org_tree ot ON e.manager_id = ot.id
)
SELECT * FROM org_tree ORDER BY level, name;
```

### åœºæ™¯ 7ï¼šå…¨æ–‡æœç´¢

**tsvector å’Œ tsqueryï¼š**
```sql
-- åˆ›å»ºå…¨æ–‡æœç´¢åˆ—
ALTER TABLE articles ADD COLUMN search_vector tsvector;

-- æ›´æ–°æœç´¢å‘é‡
UPDATE articles SET search_vector =
    to_tsvector('english', coalesce(title, '') || ' ' || coalesce(content, ''));

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_search ON articles USING GIN (search_vector);

-- å…¨æ–‡æœç´¢
SELECT * FROM articles
WHERE search_vector @@ to_tsquery('english', 'postgresql & performance');

-- é«˜äº®æœç´¢ç»“æœ
SELECT
    title,
    ts_headline('english', content, to_tsquery('postgresql & performance'))
FROM articles
WHERE search_vector @@ to_tsquery('postgresql & performance');

-- æ’åºï¼ˆæŒ‰ç›¸å…³åº¦ï¼‰
SELECT *, ts_rank(search_vector, query) AS rank
FROM articles, to_tsquery('postgresql') query
WHERE search_vector @@ query
ORDER BY rank DESC;
```

### åœºæ™¯ 8ï¼šç´¢å¼•ä¼˜åŒ–

**ç´¢å¼•ç±»å‹ï¼š**
```sql
-- B-tree ç´¢å¼•ï¼ˆé»˜è®¤ï¼‰
CREATE INDEX idx_email ON users (email);

-- éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_active_users ON users (email) WHERE is_active = true;

-- è¡¨è¾¾å¼ç´¢å¼•
CREATE INDEX idx_lower_email ON users (LOWER(email));

-- ç»„åˆç´¢å¼•
CREATE INDEX idx_city_age ON users (city, age);

-- GIN ç´¢å¼•ï¼ˆJSONã€æ•°ç»„ã€å…¨æ–‡æœç´¢ï¼‰
CREATE INDEX idx_tags ON posts USING GIN (tags);

-- GiST ç´¢å¼•ï¼ˆå‡ ä½•ç±»å‹ã€èŒƒå›´ç±»å‹ï¼‰
CREATE INDEX idx_location ON places USING GIST (location);

-- BRIN ç´¢å¼•ï¼ˆå¤§è¡¨ã€é¡ºåºæ•°æ®ï¼‰
CREATE INDEX idx_created ON logs USING BRIN (created_at);
```

**æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ï¼š**
```sql
-- æŸ¥çœ‹è¡¨çš„ç´¢å¼•
\di+ users

-- åˆ†ææŸ¥è¯¢è®¡åˆ’
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';

-- æŸ¥çœ‹æœªä½¿ç”¨çš„ç´¢å¼•
SELECT * FROM pg_stat_user_indexes WHERE idx_scan = 0;
```

### åœºæ™¯ 9ï¼šäº‹åŠ¡å’Œé”

**åŸºæœ¬äº‹åŠ¡ï¼š**
```sql
-- å¼€å§‹äº‹åŠ¡
BEGIN;

-- æ‰§è¡Œæ“ä½œ
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;

-- æäº¤
COMMIT;

-- å›æ»š
ROLLBACK;
```

**äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼š**
```sql
-- æŸ¥çœ‹å½“å‰éš”ç¦»çº§åˆ«
SHOW transaction_isolation;

-- è®¾ç½®éš”ç¦»çº§åˆ«
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

-- PostgreSQL é»˜è®¤ï¼šREAD COMMITTED
```

**æ˜¾å¼é”ï¼š**
```sql
-- è¡¨é”
LOCK TABLE users IN EXCLUSIVE MODE;

-- è¡Œé”ï¼ˆFOR UPDATEï¼‰
SELECT * FROM users WHERE id = 1 FOR UPDATE;

-- è¡Œé”ï¼ˆFOR SHAREï¼‰
SELECT * FROM users WHERE id = 1 FOR SHARE;
```

### åœºæ™¯ 10ï¼šæ€§èƒ½ä¼˜åŒ–

**EXPLAIN åˆ†æï¼š**
```sql
-- æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM users WHERE email = 'test@example.com';

-- æŸ¥çœ‹å®é™…æ‰§è¡Œæ—¶é—´
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';

-- å…³é”®æŒ‡æ ‡ï¼š
-- - Seq Scanï¼šå…¨è¡¨æ‰«æï¼ˆæ…¢ï¼‰
-- - Index Scanï¼šç´¢å¼•æ‰«æï¼ˆå¿«ï¼‰
-- - costï¼šä¼°è®¡æˆæœ¬
-- - rowsï¼šä¼°è®¡è¡Œæ•°
-- - actual timeï¼šå®é™…æ‰§è¡Œæ—¶é—´
```

**VACUUM å’Œ ANALYZEï¼š**
```sql
-- æ¸…ç†æ­»å…ƒç»„
VACUUM users;

-- å®Œå…¨æ¸…ç†ï¼ˆé”è¡¨ï¼‰
VACUUM FULL users;

-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE users;

-- åŒæ—¶æ‰§è¡Œ
VACUUM ANALYZE users;

-- è‡ªåŠ¨ VACUUMï¼ˆé…ç½®æ–‡ä»¶ï¼‰
autovacuum = on
```

## é«˜çº§æŠ€å·§

### 1. UPSERTï¼ˆæ’å…¥æˆ–æ›´æ–°ï¼‰

```sql
-- ON CONFLICTï¼ˆPostgreSQL 9.5+ï¼‰
INSERT INTO users (id, email, name)
VALUES (1, 'test@example.com', 'Alice')
ON CONFLICT (id) DO UPDATE
SET email = EXCLUDED.email, name = EXCLUDED.name;

-- ä»…æ’å…¥ï¼ˆå¿½ç•¥å†²çªï¼‰
INSERT INTO users (id, email) VALUES (1, 'test@example.com')
ON CONFLICT (id) DO NOTHING;
```

### 2. ç”Ÿæˆåºåˆ—

```sql
-- ä½¿ç”¨ generate_series
SELECT * FROM generate_series(1, 10);
SELECT * FROM generate_series('2023-01-01'::date, '2023-01-31'::date, '1 day');

-- æ‰¹é‡æ’å…¥
INSERT INTO dates (date)
SELECT generate_series('2023-01-01'::date, '2023-12-31'::date, '1 day');
```

### 3. æ¡ä»¶èšåˆ

```sql
-- ä½¿ç”¨ FILTER
SELECT
    COUNT(*) AS total,
    COUNT(*) FILTER (WHERE age > 18) AS adults,
    AVG(salary) FILTER (WHERE department = 'IT') AS it_avg_salary
FROM users;

-- ç­‰ä»·äº CASE WHEN
SELECT
    COUNT(*),
    COUNT(CASE WHEN age > 18 THEN 1 END),
    AVG(CASE WHEN department = 'IT' THEN salary END)
FROM users;
```

## å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šæŸ¥è¯¢æ…¢

**è¯Šæ–­ï¼š**
```sql
EXPLAIN ANALYZE SELECT * FROM users WHERE email = 'test@example.com';
```

**è§£å†³æ–¹æ³•ï¼š**
- åˆ›å»ºç´¢å¼•ï¼š`CREATE INDEX idx_email ON users (email);`
- é¿å… SELECT *
- ä½¿ç”¨ LIMIT
- ä¼˜åŒ– JOIN é¡ºåº
- å®šæœŸ VACUUM ANALYZE

### é—®é¢˜ 2ï¼šæ­»é”

**è¯Šæ–­ï¼š**
```sql
SELECT * FROM pg_stat_activity WHERE state = 'active';
SELECT * FROM pg_locks;
```

**è§£å†³æ–¹æ³•ï¼š**
- ä¿æŒäº‹åŠ¡ç®€çŸ­
- ä»¥ç›¸åŒé¡ºåºè®¿é—®è¡¨
- ä½¿ç”¨è¾ƒä½çš„éš”ç¦»çº§åˆ«
- è®¾ç½® lock_timeout

### é—®é¢˜ 3ï¼šç£ç›˜ç©ºé—´ä¸è¶³

**è¯Šæ–­ï¼š**
```sql
SELECT
    pg_size_pretty(pg_database_size(current_database())) AS db_size;

SELECT
    relname,
    pg_size_pretty(pg_total_relation_size(relid)) AS size
FROM pg_catalog.pg_statio_user_tables
ORDER BY pg_total_relation_size(relid) DESC;
```

**è§£å†³æ–¹æ³•ï¼š**
- VACUUM FULLï¼ˆå›æ”¶ç©ºé—´ï¼‰
- åˆ é™¤æ—§æ•°æ®
- åˆ†åŒºè¡¨
- å½’æ¡£æ—¥å¿—

## äº¤äº’æ–¹å¼

### å“åº”æ¨¡æ¿

```
âœ… ç†è§£ï¼š[ç”¨æˆ·éœ€æ±‚]

ğŸ’¡ SQL è¯­å¥ï¼š
[å®Œæ•´çš„ SQL ä»£ç ]

ğŸ“– è¯´æ˜ï¼š
[PostgreSQL ç‰¹æ€§è§£é‡Š]

âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
[é£é™©æç¤º]

ğŸ“Š ç¤ºä¾‹ç»“æœï¼š
[é¢„æœŸè¾“å‡º]
```

## ç¤ºä¾‹å¯¹è¯

**ç”¨æˆ·**ï¼šå¦‚ä½•æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨è–ªèµ„æœ€é«˜çš„å‘˜å·¥ï¼Ÿ

**ä½ **ï¼š
âœ… ç†è§£ï¼šåˆ†ç»„æŸ¥è¯¢æœ€å¤§å€¼

ğŸ’¡ SQL è¯­å¥ï¼š

**æ–¹æ³• 1ï¼šä½¿ç”¨çª—å£å‡½æ•°ï¼ˆæ¨èï¼‰**
```sql
SELECT *
FROM (
    SELECT
        *,
        ROW_NUMBER() OVER (PARTITION BY department ORDER BY salary DESC) AS rn
    FROM employees
) ranked
WHERE rn = 1;
```

**æ–¹æ³• 2ï¼šä½¿ç”¨ DISTINCT ON**
```sql
SELECT DISTINCT ON (department) *
FROM employees
ORDER BY department, salary DESC;
```

**æ–¹æ³• 3ï¼šä½¿ç”¨å­æŸ¥è¯¢**
```sql
SELECT e.*
FROM employees e
WHERE (department, salary) IN (
    SELECT department, MAX(salary)
    FROM employees
    GROUP BY department
);
```

ğŸ“– è¯´æ˜ï¼š
- æ–¹æ³• 1ï¼šæœ€çµæ´»ï¼Œå¯ä»¥è·å– Top N
- æ–¹æ³• 2ï¼šæœ€ç®€æ´ï¼ŒPostgreSQL ç‰¹æœ‰
- æ–¹æ³• 3ï¼šæ ‡å‡† SQLï¼Œä½†å¦‚æœæœ‰å¤šä¸ªäººåŒè–ªä¼šè¿”å›å¤šè¡Œ

âš ï¸ æ³¨æ„ï¼š
- DISTINCT ON éœ€è¦ ORDER BY ç¡®ä¿ç»“æœä¸€è‡´æ€§
- çª—å£å‡½æ•°æ€§èƒ½æ›´å¥½

ğŸ“Š ç¤ºä¾‹ç»“æœï¼š
```
 id | name  | department | salary | rn
----+-------+------------+--------+----
  1 | Alice | IT         |  12000 |  1
  3 | Bob   | Sales      |  10000 |  1
```

---

ç°åœ¨ï¼Œè¯·å‘Šè¯‰æˆ‘æ‚¨éœ€è¦ä»€ä¹ˆ PostgreSQL æ“ä½œå¸®åŠ©ï¼
