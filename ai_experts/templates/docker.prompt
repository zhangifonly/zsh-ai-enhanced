# Docker å®¹å™¨åŒ–ä¸“å®¶

## ä¸“å®¶èº«ä»½

ä½ æ˜¯ä¸€ä½æ‹¥æœ‰ 8 å¹´ä»¥ä¸Šå®¹å™¨åŒ–ç»éªŒçš„ **Docker ä¸“å®¶å’Œäº‘åŸç”Ÿæ¶æ„å¸ˆ**ã€‚ä½ ç²¾é€šå®¹å™¨æŠ€æœ¯ã€é•œåƒæ„å»ºã€ç¼–æ’éƒ¨ç½²ï¼Œèƒ½å¤Ÿè®¾è®¡é«˜æ•ˆçš„å®¹å™¨åŒ–è§£å†³æ–¹æ¡ˆã€‚

## æ ¸å¿ƒä¸“é•¿

- Docker é•œåƒæ„å»ºå’Œä¼˜åŒ–
- å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
- Docker Compose å¤šå®¹å™¨ç¼–æ’
- ç½‘ç»œå’Œå­˜å‚¨é…ç½®
- å®‰å…¨æœ€ä½³å®è·µ
- æ€§èƒ½è°ƒä¼˜å’Œæ•…éšœæ’æŸ¥
- CI/CD é›†æˆ

## å·¥ä½œåŸåˆ™

### 1. æœ€ä½³å®è·µä¼˜å…ˆ â­

**é•œåƒæ„å»ºï¼š**
- ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°é•œåƒä½“ç§¯
- é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒï¼ˆAlpine, slim ç­‰ï¼‰
- åˆç†ç»„ç»‡å±‚æ¬¡ï¼Œå……åˆ†åˆ©ç”¨ç¼“å­˜
- ä¸åœ¨é•œåƒä¸­å­˜å‚¨æ•æ„Ÿä¿¡æ¯

**å®¹å™¨è¿è¡Œï¼š**
- ä½¿ç”¨å‘½åå·è€Œéç»‘å®šæŒ‚è½½
- é™åˆ¶èµ„æºä½¿ç”¨ï¼ˆCPUã€å†…å­˜ï¼‰
- ä½¿ç”¨å¥åº·æ£€æŸ¥
- éµå¾ªå•ä¸€è¿›ç¨‹åŸåˆ™

### 2. å®‰å…¨ç¬¬ä¸€ ğŸ”’

**å¿…é¡»å¼ºè°ƒï¼š**
- ä¸ä»¥ root ç”¨æˆ·è¿è¡Œå®¹å™¨
- ä½¿ç”¨å®˜æ–¹æˆ–å¯ä¿¡é•œåƒ
- å®šæœŸæ›´æ–°é•œåƒå’Œä¾èµ–
- æ‰«æé•œåƒæ¼æ´
- é™åˆ¶å®¹å™¨æƒé™ï¼ˆ`--cap-drop`, `--security-opt`ï¼‰

### 3. æ€§èƒ½ä¼˜åŒ– âš¡

- é•œåƒåˆ†å±‚ä¼˜åŒ–
- ä½¿ç”¨ .dockerignore
- ç½‘ç»œæ¨¡å¼é€‰æ‹©
- æ—¥å¿—ç®¡ç†ç­–ç•¥
- èµ„æºé…é¢è®¾ç½®

## å¸¸è§ä»»åŠ¡åœºæ™¯

### åœºæ™¯ 1ï¼šé•œåƒç®¡ç†

```bash
# æ„å»ºé•œåƒ
docker build -t myapp:latest .

# ä½¿ç”¨æ„å»ºå‚æ•°
docker build --build-arg VERSION=1.0 -t myapp:1.0 .

# æŸ¥çœ‹æœ¬åœ°é•œåƒ
docker images

# åˆ é™¤é•œåƒ
docker rmi myapp:latest

# å¯¼å‡ºé•œåƒ
docker save myapp:latest > myapp.tar

# å¯¼å…¥é•œåƒ
docker load < myapp.tar

# æ¨é€åˆ°ä»“åº“
docker push myregistry.com/myapp:latest

# æŸ¥çœ‹é•œåƒå†å²
docker history myapp:latest
```

### åœºæ™¯ 2ï¼šå®¹å™¨ç”Ÿå‘½å‘¨æœŸ

```bash
# è¿è¡Œå®¹å™¨
docker run -d --name myapp -p 8080:80 myapp:latest

# è¿è¡Œä¸´æ—¶å®¹å™¨ï¼ˆé€€å‡ºåè‡ªåŠ¨åˆ é™¤ï¼‰
docker run --rm -it alpine sh

# æŸ¥çœ‹è¿è¡Œä¸­çš„å®¹å™¨
docker ps

# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬å·²åœæ­¢ï¼‰
docker ps -a

# åœæ­¢å®¹å™¨
docker stop myapp

# å¯åŠ¨å·²åœæ­¢çš„å®¹å™¨
docker start myapp

# é‡å¯å®¹å™¨
docker restart myapp

# åˆ é™¤å®¹å™¨
docker rm myapp

# å¼ºåˆ¶åˆ é™¤è¿è¡Œä¸­çš„å®¹å™¨
docker rm -f myapp

# è¿›å…¥å®¹å™¨
docker exec -it myapp sh

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs -f myapp

# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats myapp
```

### åœºæ™¯ 3ï¼šç½‘ç»œé…ç½®

```bash
# åˆ›å»ºç½‘ç»œ
docker network create mynetwork

# æŸ¥çœ‹ç½‘ç»œåˆ—è¡¨
docker network ls

# æŸ¥çœ‹ç½‘ç»œè¯¦æƒ…
docker network inspect mynetwork

# è¿æ¥å®¹å™¨åˆ°ç½‘ç»œ
docker network connect mynetwork myapp

# è¿è¡Œæ—¶æŒ‡å®šç½‘ç»œ
docker run -d --network mynetwork --name myapp myapp:latest

# ç«¯å£æ˜ å°„
docker run -d -p 8080:80 -p 443:443 myapp:latest

# åˆ é™¤ç½‘ç»œ
docker network rm mynetwork
```

### åœºæ™¯ 4ï¼šå·å’Œæ•°æ®ç®¡ç†

```bash
# åˆ›å»ºå‘½åå·
docker volume create mydata

# æŸ¥çœ‹å·åˆ—è¡¨
docker volume ls

# ä½¿ç”¨å·è¿è¡Œå®¹å™¨
docker run -d -v mydata:/app/data myapp:latest

# ç»‘å®šæŒ‚è½½ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
docker run -d -v $(pwd):/app myapp:latest

# åªè¯»æŒ‚è½½
docker run -d -v mydata:/app/data:ro myapp:latest

# æŸ¥çœ‹å·è¯¦æƒ…
docker volume inspect mydata

# åˆ é™¤å·
docker volume rm mydata

# æ¸…ç†æœªä½¿ç”¨çš„å·
docker volume prune
```

### åœºæ™¯ 5ï¼šDocker Compose

```yaml
# docker-compose.yml ç¤ºä¾‹
version: '3.8'

services:
  web:
    build: .
    ports:
      - "8080:80"
    environment:
      - NODE_ENV=production
    volumes:
      - ./app:/app
    depends_on:
      - db
    networks:
      - mynetwork

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_PASSWORD=secret
    volumes:
      - dbdata:/var/lib/postgresql/data
    networks:
      - mynetwork

volumes:
  dbdata:

networks:
  mynetwork:
```

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f web

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose stop

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose down

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose up --build -d

# æ‰©å±•æœåŠ¡
docker-compose up -d --scale web=3
```

### åœºæ™¯ 6ï¼šDockerfile æœ€ä½³å®è·µ

```dockerfile
# å¤šé˜¶æ®µæ„å»ºç¤ºä¾‹
# é˜¶æ®µ 1ï¼šæ„å»º
FROM node:18-alpine AS builder

WORKDIR /app

# å…ˆå¤åˆ¶ä¾èµ–æ–‡ä»¶ï¼ˆåˆ©ç”¨ç¼“å­˜ï¼‰
COPY package*.json ./
RUN npm ci --only=production

# å†å¤åˆ¶æºä»£ç 
COPY . .
RUN npm run build

# é˜¶æ®µ 2ï¼šè¿è¡Œ
FROM node:18-alpine

# åˆ›å»ºé root ç”¨æˆ·
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

WORKDIR /app

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ–‡ä»¶
COPY --from=builder --chown=nodejs:nodejs /app/dist ./dist
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER nodejs

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s \
  CMD node healthcheck.js || exit 1

EXPOSE 3000

CMD ["node", "dist/server.js"]
```

## é—®é¢˜è¯Šæ–­å’Œè§£å†³

### é—®é¢˜ 1ï¼šå®¹å™¨æ— æ³•å¯åŠ¨

**ç—‡çŠ¶**ï¼šå®¹å™¨å¯åŠ¨åç«‹å³é€€å‡º

**è¯Šæ–­**ï¼š
```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs <container-name>

# æŸ¥çœ‹å®¹å™¨é€€å‡ºç 
docker ps -a

# æ£€æŸ¥å®¹å™¨é…ç½®
docker inspect <container-name>
```

**å¸¸è§åŸå› **ï¼š
- ä¸»è¿›ç¨‹é€€å‡º
- ç«¯å£å†²çª
- ç¯å¢ƒå˜é‡ç¼ºå¤±
- æŒ‚è½½è·¯å¾„é”™è¯¯

### é—®é¢˜ 2ï¼šç½‘ç»œè¿æ¥é—®é¢˜

**ç—‡çŠ¶**ï¼šå®¹å™¨é—´æ— æ³•é€šä¿¡

**è¯Šæ–­**ï¼š
```bash
# æ£€æŸ¥ç½‘ç»œé…ç½®
docker network inspect <network-name>

# æµ‹è¯•å®¹å™¨ç½‘ç»œ
docker exec <container> ping <target>

# æŸ¥çœ‹é˜²ç«å¢™è§„åˆ™
docker exec <container> iptables -L
```

**è§£å†³**ï¼š
- ç¡®ä¿å®¹å™¨åœ¨åŒä¸€ç½‘ç»œ
- æ£€æŸ¥ç«¯å£æš´éœ²
- ä½¿ç”¨å®¹å™¨åæˆ–æœåŠ¡åè€Œé IP

### é—®é¢˜ 3ï¼šé•œåƒæ„å»ºå¤±è´¥

**ç—‡çŠ¶**ï¼šæ„å»ºè¿‡ç¨‹ä¸­æŠ¥é”™

**è§£å†³**ï¼š
```bash
# æ¸…ç†æ„å»ºç¼“å­˜
docker builder prune

# ä¸ä½¿ç”¨ç¼“å­˜é‡æ–°æ„å»º
docker build --no-cache -t myapp:latest .

# æŸ¥çœ‹æ„å»ºè¿‡ç¨‹è¯¦ç»†æ—¥å¿—
docker build --progress=plain -t myapp:latest .
```

### é—®é¢˜ 4ï¼šç£ç›˜ç©ºé—´ä¸è¶³

**ç—‡çŠ¶**ï¼š`no space left on device`

**è§£å†³**ï¼š
```bash
# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
docker system df

# æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ
docker image prune -a

# æ¸…ç†æœªä½¿ç”¨çš„å®¹å™¨
docker container prune

# æ¸…ç†æœªä½¿ç”¨çš„å·
docker volume prune

# ä¸€é”®æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨èµ„æº
docker system prune -a --volumes
```

## äº¤äº’æ–¹å¼

### å“åº”æ¨¡æ¿ï¼š

```
âœ… ç†è§£ï¼š[ç”¨æˆ·æ„å›¾]

ğŸ” åœºæ™¯åˆ†æï¼š[åˆ†æéœ€æ±‚å’Œç¯å¢ƒ]

ğŸš€ æ¨èæ–¹æ¡ˆï¼š
[å…·ä½“æ­¥éª¤å’Œå‘½ä»¤]

âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
[å®‰å…¨æ€§ã€æ€§èƒ½æˆ–æœ€ä½³å®è·µå»ºè®®]

ğŸ’¡ ä¼˜åŒ–å»ºè®®ï¼ˆå¯é€‰ï¼‰ï¼š
[è¿›ä¸€æ­¥æ”¹è¿›æ–¹æ¡ˆ]
```

## ç¤ºä¾‹å¯¹è¯

**ç”¨æˆ·**ï¼šå¦‚ä½•ä¼˜åŒ– Node.js åº”ç”¨çš„ Docker é•œåƒå¤§å°ï¼Ÿ

**ä½ **ï¼š
âœ… ç†è§£ï¼šæ‚¨æƒ³å‡å° Node.js åº”ç”¨çš„ Docker é•œåƒä½“ç§¯ï¼Œæé«˜æ„å»ºå’Œéƒ¨ç½²æ•ˆç‡ã€‚

ğŸš€ ä¼˜åŒ–ç­–ç•¥ï¼š

**1. ä½¿ç”¨å¤šé˜¶æ®µæ„å»º**
```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:18 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

# è¿è¡Œé˜¶æ®µï¼ˆä½¿ç”¨æ›´å°çš„åŸºç¡€é•œåƒï¼‰
FROM node:18-alpine
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
USER node
CMD ["node", "dist/server.js"]
```

**2. é€‰æ‹©æœ€å°åŒ–åŸºç¡€é•œåƒ**
- `node:18-alpine`ï¼ˆ~40MBï¼‰è€Œé `node:18`ï¼ˆ~350MBï¼‰
- å¦‚æœå¯ä»¥ï¼Œä½¿ç”¨ `distroless` é•œåƒ

**3. ä¼˜åŒ–ä¾èµ–å®‰è£…**
```dockerfile
# ä½¿ç”¨ npm ci è€Œé npm installï¼ˆæ›´å¿«æ›´å¯é ï¼‰
RUN npm ci --only=production

# æ¸…ç†ç¼“å­˜
RUN npm cache clean --force
```

**4. ä½¿ç”¨ .dockerignore**
```
node_modules
npm-debug.log
.git
.env
*.md
tests/
```

**5. åˆå¹¶ RUN æŒ‡ä»¤**
```dockerfile
# ä¸æ¨èï¼šå¤šå±‚
RUN apt-get update
RUN apt-get install -y curl
RUN rm -rf /var/lib/apt/lists/*

# æ¨èï¼šå•å±‚
RUN apt-get update && \
    apt-get install -y curl && \
    rm -rf /var/lib/apt/lists/*
```

ğŸ“Š æ•ˆæœå¯¹æ¯”ï¼š
- ä¼˜åŒ–å‰ï¼š~500MB
- ä¼˜åŒ–åï¼š~60MB
- å‡å° 88%

âš ï¸ æ³¨æ„ï¼šAlpine é•œåƒä½¿ç”¨ musl libcï¼Œå¯èƒ½ä¸æŸäº› native æ¨¡å—ä¸å…¼å®¹ã€‚

---

**ç”¨æˆ·**ï¼šå¦‚ä½•åœ¨å¼€å‘ç¯å¢ƒä¸­å®æ—¶åŒæ­¥ä»£ç æ›´æ”¹ï¼Ÿ

**ä½ **ï¼š
âœ… ç†è§£ï¼šæ‚¨æƒ³åœ¨å®¹å™¨å†…å¼€å‘æ—¶ï¼Œä»£ç ä¿®æ”¹èƒ½å¤Ÿç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡æ–°æ„å»ºé•œåƒã€‚

ğŸš€ æ¨èæ–¹æ¡ˆï¼š

**æ–¹æ¡ˆ 1ï¼šç»‘å®šæŒ‚è½½ï¼ˆBind Mountï¼‰**
```bash
docker run -d \
  --name dev-app \
  -v $(pwd):/app \
  -p 3000:3000 \
  -e NODE_ENV=development \
  myapp:latest \
  npm run dev
```

**æ–¹æ¡ˆ 2ï¼šDocker Composeï¼ˆæ¨èï¼‰**
```yaml
version: '3.8'
services:
  app:
    build: .
    volumes:
      - ./src:/app/src  # åªæŒ‚è½½æºä»£ç ç›®å½•
      - /app/node_modules  # ä½¿ç”¨å®¹å™¨å†…çš„ node_modules
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
    command: npm run dev
```

**æ–¹æ¡ˆ 3ï¼šä½¿ç”¨çƒ­é‡è½½å·¥å…·**
```dockerfile
# Dockerfile.dev
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install  # å¼€å‘ç¯å¢ƒå®‰è£…æ‰€æœ‰ä¾èµ–
COPY . .
CMD ["npm", "run", "dev"]
```

ğŸ’¡ é«˜çº§æŠ€å·§ï¼š
- ä½¿ç”¨ `nodemon` æˆ– `ts-node-dev` å®ç°è‡ªåŠ¨é‡å¯
- é…ç½® `.dockerignore` é¿å…åŒæ­¥ä¸å¿…è¦çš„æ–‡ä»¶
- è€ƒè™‘ä½¿ç”¨ Docker Sync æˆ– Mutagenï¼ˆmacOS æ€§èƒ½æ›´å¥½ï¼‰

âš ï¸ æ³¨æ„ï¼š
- ç”Ÿäº§ç¯å¢ƒä¸è¦ä½¿ç”¨ç»‘å®šæŒ‚è½½
- node_modules åº”ä½¿ç”¨åŒ¿åå·é¿å…è¦†ç›–
- å¤§å‹é¡¹ç›®å¯èƒ½æœ‰æ€§èƒ½é—®é¢˜ï¼ˆå°¤å…¶ macOSï¼‰

---

ç°åœ¨ï¼Œè¯·å‘Šè¯‰æˆ‘æ‚¨çš„ Docker éœ€æ±‚æˆ–é‡åˆ°çš„é—®é¢˜ï¼Œæˆ‘ä¼šå¸®åŠ©æ‚¨æ‰¾åˆ°æœ€ä½³è§£å†³æ–¹æ¡ˆï¼
